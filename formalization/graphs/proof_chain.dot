digraph proof_chain {
    // Graph attributes
    graph [
        label = "NitscheHodgeLaplacian — Proof Chain Dependency Graph\nMain.lean (Tello Fachin, Tonnon, Zampa 2025)"
        labelloc = "t"
        fontsize = 16
        fontname = "Helvetica"
        rankdir = "BT"
        bgcolor = "white"
        splines = "polyline"
        nodesep = 0.6
        ranksep = 1.0
    ]

    node [fontname = "Helvetica" fontsize = 10 style = "filled"]
    edge [color = "#444444" arrowsize = 0.75]

    // ----------------------------------------------------------------
    // LEGEND (invisible subgraph to fix legend nodes in top-left area)
    // ----------------------------------------------------------------
    subgraph cluster_legend {
        label = "Legend"
        fontsize = 11
        style = "rounded"
        color = "#aaaaaa"

        L_axiom   [label = "axiom / opaque input"  fillcolor = "#ffcccc" color = "#cc0000" style = "filled,dashed"]
        L_estab   [label = "established result"    fillcolor = "#cce0ff" color = "#0044cc" style = "filled"]
        L_novel   [label = "novel result"          fillcolor = "#ccffcc" color = "#007700" style = "filled"]
        L_proved  [label = "proved theorem"        fillcolor = "#fff3b0" color = "#996600" style = "filled"]
        L_main    [label = "main theorem / corollary" fillcolor = "#00aa55" fontcolor = "white" color = "#005522" style = "filled,bold"]
        L_open    [label = "open hypothesis"       fillcolor = "#ffe0b0" color = "#cc6600" style = "filled,dashed"]
    }

    // ----------------------------------------------------------------
    // TIER 0: Axiom / opaque inputs (the raw hypotheses)
    // ----------------------------------------------------------------
    subgraph cluster_inputs {
        label = "Axioms / Opaque Inputs"
        style = "rounded"
        color = "#cccccc"
        fontsize = 12

        XNorm [
            label = "XNorm\n[Established: Def. 3.1.7]\nMesh-dependent product norm"
            fillcolor = "#ffcccc"
            color = "#cc0000"
            style = "filled,dashed"
            shape = "box"
        ]
        XNorm_nonneg [
            label = "XNorm_nonneg\n[Established]\nNon-negativity of X-norm"
            fillcolor = "#ffcccc"
            color = "#cc0000"
            style = "filled,dashed"
            shape = "box"
        ]
        criticalTermSup [
            label = "criticalTermSup\n[Novel: proof of Thm 4.1]\nsup_{y_h≠0} |⟨ω−Pω, d τ_h⟩| / ‖y_h‖_X"
            fillcolor = "#ccffcc"
            color = "#007700"
            style = "filled,dashed"
            shape = "box"
        ]
        lpApproxError [
            label = "lpApproxError\n[Novel: Cor. 3.7]\n‖ω − Pω‖_{Lp}"
            fillcolor = "#ccffcc"
            color = "#007700"
            style = "filled,dashed"
            shape = "box"
        ]
        DiscreteHodgeLpStable [
            label = "DiscreteHodgeLpStable\n[Open: Issue #2]\nDiscrete Hodge Lp stability\n(open problem for k=2, p>6)"
            fillcolor = "#ffe0b0"
            color = "#cc6600"
            style = "filled,dashed"
            shape = "box"
        ]
    }

    // ----------------------------------------------------------------
    // TIER 1: Direct proof-chain axioms
    // ----------------------------------------------------------------
    bnb_with_noncritical [
        label = "bnb_with_noncritical\n[Established: Lem. 3.5.2 + Thm. 3.3.7 + Thm. 3.5.3]\nBNB quasi-optimality + non-critical terms"
        fillcolor = "#cce0ff"
        color = "#0044cc"
        style = "filled"
        shape = "box"
    ]
    key_bound [
        label = "key_bound\n[Novel: Lemma 3.3]\nAdapts [AFG12, Thm 3.6] to 3D\ncriticalTermSup ≤ C·h^{−1/2−1/p}·lpApproxError"
        fillcolor = "#ccffcc"
        color = "#007700"
        style = "filled"
        shape = "box"
    ]
    lp_approximation [
        label = "lp_approximation\n[Novel: Corollary 3.7]\nLp stability of P + discrete Poincaré\nlpApproxError ≤ C·h^l·‖ω‖_{W^{l,p}}"
        fillcolor = "#ccffcc"
        color = "#007700"
        style = "filled"
        shape = "box"
    ]
    k1_limit_bound [
        label = "k1_limit_bound\n[Novel: Thm 4.1(a) limit step]\np→∞ limit using [SW82, Thm. 5.1]\nL∞ stability for k=1"
        fillcolor = "#ccffcc"
        color = "#007700"
        style = "filled"
        shape = "box"
    ]
    k2_conditional_lp_stability [
        label = "k2_conditional_lp_stability\n[Novel: Corollary 4.2 axiom]\nUnder DiscreteHodgeLpStable:\nk=2 achieves same rate as k=1"
        fillcolor = "#ccffcc"
        color = "#007700"
        style = "filled"
        shape = "box"
    ]

    // ----------------------------------------------------------------
    // TIER 2: Private helper lemmas
    // ----------------------------------------------------------------
    absorb_constant [
        label = "absorb_constant\n[helper]\nAbsorb two constants via max"
        fillcolor = "#f5f5dc"
        color = "#888800"
        style = "filled"
        shape = "box"
        fontsize = 9
    ]
    exponent_k2 [
        label = "exponent_k2\n[helper]\nl − 1/2 − 1/6 = l − 2/3"
        fillcolor = "#f5f5dc"
        color = "#888800"
        style = "filled"
        shape = "box"
        fontsize = 9
    ]

    // ----------------------------------------------------------------
    // TIER 3: Proved intermediate theorems
    // ----------------------------------------------------------------
    critical_term_lp_bound [
        label = "critical_term_lp_bound\n[Proved: chains key_bound + lp_approximation]\ncriticalTermSup ≤ C·h^{l−1/2−1/p}·‖ω‖_{W^{l,p}}"
        fillcolor = "#fff3b0"
        color = "#996600"
        style = "filled"
        shape = "box"
        penwidth = 2
    ]
    parametric_error_bound [
        label = "parametric_error_bound\n[Proved: chains bnb_with_noncritical + critical_term_lp_bound]\n‖error‖_X ≤ C(h^{r−1/2} + h^{l−1/2−1/p}·‖ω‖_{W^{l,p}})"
        fillcolor = "#fff3b0"
        color = "#996600"
        style = "filled"
        shape = "box"
        penwidth = 2
    ]

    // ----------------------------------------------------------------
    // TIER 4: Main results
    // ----------------------------------------------------------------
    nitsche_hodge_laplacian_k1 [
        label = "nitsche_hodge_laplacian_k1\n[Theorem 4.1(a)]\nk=1 (H(curl)): rate h^{r−1/2} + h^{l−1/2}"
        fillcolor = "#00aa55"
        fontcolor = "white"
        color = "#005522"
        style = "filled,bold"
        shape = "box"
        penwidth = 3
        fontsize = 11
    ]
    nitsche_hodge_laplacian_k2 [
        label = "nitsche_hodge_laplacian_k2\n[Theorem 4.1(b)]\nk=2 (H(div)): rate h^{r−1/2} + h^{l−2/3}"
        fillcolor = "#00aa55"
        fontcolor = "white"
        color = "#005522"
        style = "filled,bold"
        shape = "box"
        penwidth = 3
        fontsize = 11
    ]
    nitsche_hodge_laplacian_k2_conditional [
        label = "nitsche_hodge_laplacian_k2_conditional\n[Corollary 4.2]\nk=2 conditional on DiscreteHodgeLpStable:\nrate h^{r−1/2} + h^{l−1/2}"
        fillcolor = "#007744"
        fontcolor = "white"
        color = "#003322"
        style = "filled,bold"
        shape = "box"
        penwidth = 3
        fontsize = 11
    ]

    // ----------------------------------------------------------------
    // EDGES: proof dependencies
    // ----------------------------------------------------------------

    // Tier 1 axioms depend on opaque inputs
    bnb_with_noncritical -> XNorm
    bnb_with_noncritical -> criticalTermSup

    key_bound -> criticalTermSup
    key_bound -> lpApproxError

    lp_approximation -> lpApproxError

    k1_limit_bound -> XNorm
    k1_limit_bound -> XNorm_nonneg

    k2_conditional_lp_stability -> XNorm
    k2_conditional_lp_stability -> XNorm_nonneg
    k2_conditional_lp_stability -> DiscreteHodgeLpStable

    // Tier 2 helpers
    absorb_constant -> XNorm_nonneg

    // critical_term_lp_bound chains key_bound + lp_approximation
    critical_term_lp_bound -> key_bound
    critical_term_lp_bound -> lp_approximation

    // parametric_error_bound chains bnb + critical_term
    parametric_error_bound -> bnb_with_noncritical
    parametric_error_bound -> critical_term_lp_bound
    parametric_error_bound -> absorb_constant
    parametric_error_bound -> XNorm_nonneg

    // Main theorems
    nitsche_hodge_laplacian_k1 -> k1_limit_bound

    nitsche_hodge_laplacian_k2 -> parametric_error_bound
    nitsche_hodge_laplacian_k2 -> exponent_k2

    nitsche_hodge_laplacian_k2_conditional -> k2_conditional_lp_stability

    // ----------------------------------------------------------------
    // Rank hints for layered layout
    // ----------------------------------------------------------------
    { rank = same; XNorm; XNorm_nonneg; criticalTermSup; lpApproxError; DiscreteHodgeLpStable }
    { rank = same; bnb_with_noncritical; key_bound; lp_approximation; k1_limit_bound; k2_conditional_lp_stability }
    { rank = same; absorb_constant; exponent_k2; critical_term_lp_bound }
    { rank = same; parametric_error_bound }
    { rank = same; nitsche_hodge_laplacian_k1; nitsche_hodge_laplacian_k2; nitsche_hodge_laplacian_k2_conditional }
}
